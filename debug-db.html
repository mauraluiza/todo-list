<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Diagn√≥stico de Banco de Dados</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            background: #f4f4f4;
            color: #333;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #2c3e50;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            transition: background 0.2s;
        }

        button:hover {
            background: #2980b9;
        }

        #log {
            white-space: pre-wrap;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 4px;
            font-family: monospace;
            min-height: 200px;
        }

        .success {
            color: #2ecc71;
            font-weight: bold;
        }

        .error {
            color: #e74c3c;
            font-weight: bold;
        }

        .warning {
            color: #f39c12;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>üõ†Ô∏è Diagn√≥stico de Conex√£o e Banco</h1>
    <div class="card">
        <p>Este utilit√°rio testar√° a conex√£o com o Supabase, a autentica√ß√£o e as permiss√µes de escrita (Tasks e
            Folders).</p>
        <button id="startTest">Iniciar Testes</button>
    </div>

    <div class="card">
        <h3>Log de Execu√ß√£o:</h3>
        <div id="log">Aguardando in√≠cio...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script>
        const logEl = document.getElementById('log');
        const btn = document.getElementById('startTest');

        function log(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            let color = '#ecf0f1';
            if (type === 'success') color = '#2ecc71';
            if (type === 'error') color = '#e74c3c';
            if (type === 'warning') color = '#f39c12';

            const span = `<span style="color:${color}">[${time}] ${msg}</span>`;
            logEl.innerHTML += span + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function runTests() {
            logEl.innerHTML = '';
            btn.disabled = true;
            btn.textContent = 'Executando...';

            try {
                log('1. Verificando Configura√ß√£o da Biblioteca...', 'info');
                if (!window.supabase) {
                    throw new Error('Biblioteca Supabase n√£o inicializada. Verifique js/supabase-config.js');
                }
                log('Biblioteca OK.', 'success');

                log('2. Verificando Sess√£o de Usu√°rio...', 'info');
                const { data: { session }, error: authError } = await supabase.auth.getSession();

                if (authError) throw authError;

                if (!session) {
                    log('Nenhum usu√°rio logado. Por favor, fa√ßa login na aplica√ß√£o principal primeiro e recarregue esta p√°gina.', 'warning');
                    log('Pulando testes de escrita (requer login).', 'warning');
                    btn.disabled = false;
                    btn.textContent = 'Iniciar Testes';
                    return;
                }

                const user = session.user;
                log(`Usu√°rio logado: ${user.email} (ID: ${user.id})`, 'success');

                // TESTE 3: Cria√ß√£o de Pasta
                log('3. Testando Cria√ß√£o de Pasta (Folders)...', 'info');
                const testFolderId = 'test_f_' + Date.now();
                const { data: folderData, error: folderError } = await supabase.from('folders').insert({
                    id: testFolderId,
                    user_id: user.id,
                    name: 'Pasta de Teste Diagn√≥stico'
                }).select();

                if (folderError) {
                    log(`FALHA ao criar pasta: ${folderError.code} - ${folderError.message}`, 'error');
                    log('Dica: Verifique se a tabela "folders" existe e se as pol√≠ticas RLS permitem INSERT.', 'warning');
                } else {
                    log('Pasta criada com sucesso!', 'success');

                    // Limpeza (opcional, mas bom)
                    log('   Apagando pasta de teste...', 'info');
                    await supabase.from('folders').delete().eq('id', testFolderId);
                }

                // TESTE 4: Cria√ß√£o de Tarefa sem Pasta (Teste do Bug FK)
                log('4. Testando Cria√ß√£o de Tarefa SEM Pasta (Teste de Corre√ß√£o FK)...', 'info');
                const testTaskId1 = Date.now();
                const { data: task1Data, error: task1Error } = await supabase.from('tasks').insert({
                    id: testTaskId1,
                    user_id: user.id,
                    title: 'Tarefa Teste Sem Pasta',
                    folder_id: null // O CORRETO √â NULL
                }).select();

                if (task1Error) {
                    log(`FALHA ao criar tarefa sem pasta: ${task1Error.message}`, 'error');
                } else {
                    log('Tarefa sem pasta criada com sucesso! (Configura√ß√£o de NULL correta)', 'success');
                    await supabase.from('tasks').delete().eq('id', testTaskId1);
                }

                // TESTE 5: Listagem
                log('5. Testando Leitura (Select)...', 'info');
                const { data: listData, error: listError } = await supabase.from('tasks').select('*').limit(1);
                if (listError) {
                    log(`Erro ao ler tarefas: ${listError.message}`, 'error');
                } else {
                    log(`Leitura OK. Conseguiu acessar ${listData.length} tarefas.`, 'success');
                }

                log('--- Diagn√≥stico Conclu√≠do ---', 'success');

            } catch (err) {
                log(`ERRO CR√çTICO: ${err.message}`, 'error');
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Iniciar Testes';
            }
        }

        btn.addEventListener('click', runTests);
    </script>
</body>

</html>